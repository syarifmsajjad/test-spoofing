<script>
  // Konfigurasi jaringan (contoh: Polygon Mainnet)
  const TARGET = {
    chainId: '0x89', // 137 desimal
    chainName: 'Polygon Mainnet',
    rpcUrls: ['https://polygon-rpc.com/'],
    nativeCurrency: { name: 'MATIC', symbol: 'MATIC', decimals: 18 },
    blockExplorerUrls: ['https://polygonscan.com/']
  };

  // Tunggu hingga window.ethereum tersedia (maks 5 detik)
  function waitForEthereum(timeoutMs = 5000) {
    return new Promise((resolve, reject) => {
      if (window.ethereum) return resolve(window.ethereum);
      const started = Date.now();
      const iv = setInterval(() => {
        if (window.ethereum) {
          clearInterval(iv);
          resolve(window.ethereum);
        } else if (Date.now() - started > timeoutMs) {
          clearInterval(iv);
          reject(new Error('Ethereum provider tidak ditemukan.'));
        }
      }, 50);
    });
  }

  async function ensureTargetChainAuto() {
    try {
      const ethereum = await waitForEthereum();

      // Jika sudah di chain target, selesai
      if (ethereum.chainId && ethereum.chainId.toLowerCase() === TARGET.chainId.toLowerCase()) {
        return;
      }

      // Coba switch dulu
      try {
        await ethereum.request({
          method: 'wallet_switchEthereumChain',
          params: [{ chainId: TARGET.chainId }],
        });
        return;
      } catch (err) {
        // 4902 = chain belum terdaftar di wallet → add
        if (err && (err.code === 4902 || err.data?.originalError?.code === 4902)) {
          await ethereum.request({
            method: 'wallet_addEthereumChain',
            params: [TARGET],
          });
          return;
        }
        // 4001 = user reject → biarkan, jangan spam
        if (err && err.code === 4001) {
          console.warn('User menolak switch chain.');
          return;
        }
        // Error lain, coba langsung add sebagai fallback terakhir
        try {
          await ethereum.request({
            method: 'wallet_addEthereumChain',
            params: [TARGET],
          });
        } catch (e) {
          console.error('Gagal menambahkan jaringan:', e);
        }
      }
    } catch (e) {
      console.warn(e.message || e);
    }
  }

  // Otomatis jalan saat halaman siap
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', ensureTargetChainAuto, { once: true });
  } else {
    ensureTargetChainAuto();
  }

  // Opsional: update status jika user ganti jaringan setelahnya
  if (typeof window !== 'undefined') {
    window.addEventListener('ethereum#initialized', () => {}, { once: true });
    window.ethereum?.on?.('chainChanged', (cid) => {
      // Bisa tambah logic kalau perlu (mis. redirect atau notifikasi)
      console.log('Chain changed to', cid);
    });
  }
</script>
